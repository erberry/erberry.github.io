<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>goæºç è§£æä¹‹TCPè¿æ¥ï¼ˆä¸€ï¼‰â€”â€”Listen - åˆ˜ç®çš„åšå®¢</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="åˆ˜ç®" /><meta name="description" content="goæºç è§£æä¹‹TCPè¿æ¥" /><meta name="keywords" content="Go, æºç è§£æ, ç½‘ç»œç¼–ç¨‹" />






<meta name="generator" content="Hugo 0.92.1 with theme even" />


<link rel="canonical" href="https://erberry.github.io/post/go-tcp1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.1443c0d397a940890aabf6f7889250fa06488ec6fcb6598c8d3bc4dc12533f6f.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="goæºç è§£æä¹‹TCPè¿æ¥ï¼ˆä¸€ï¼‰â€”â€”Listen" />
<meta property="og:description" content="goæºç è§£æä¹‹TCPè¿æ¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://erberry.github.io/post/go-tcp1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-12T19:57:05+08:00" />
<meta property="article:modified_time" content="2022-02-12T19:57:05+08:00" />

<meta itemprop="name" content="goæºç è§£æä¹‹TCPè¿æ¥ï¼ˆä¸€ï¼‰â€”â€”Listen">
<meta itemprop="description" content="goæºç è§£æä¹‹TCPè¿æ¥"><meta itemprop="datePublished" content="2022-02-12T19:57:05+08:00" />
<meta itemprop="dateModified" content="2022-02-12T19:57:05+08:00" />
<meta itemprop="wordCount" content="5563">
<meta itemprop="keywords" content="Go,æºç è§£æ,ç½‘ç»œç¼–ç¨‹," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="goæºç è§£æä¹‹TCPè¿æ¥ï¼ˆä¸€ï¼‰â€”â€”Listen"/>
<meta name="twitter:description" content="goæºç è§£æä¹‹TCPè¿æ¥"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">åˆ˜ç®çš„åšå®¢</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">ä¸»é¡µ</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">åˆ†ç±»</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">å…³äº</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">åˆ˜ç®çš„åšå®¢</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">ä¸»é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">åˆ†ç±»</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">å…³äº</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">goæºç è§£æä¹‹TCPè¿æ¥ï¼ˆä¸€ï¼‰â€”â€”Listen</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-12 </span>
        <div class="post-category">
            <a href="/categories/go/"> Go </a>
            </div>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ç«¯å£æ˜¯å¦‚ä½•ç›‘å¬çš„">ç«¯å£æ˜¯å¦‚ä½•ç›‘å¬çš„</a>
      <ul>
        <li><a href="#1-netlisten">1. net.Listen</a></li>
        <li><a href="#2listenconfigçš„listenæ–¹æ³•">2.ListenConfigçš„Listenæ–¹æ³•</a></li>
        <li><a href="#syslistenerlistentcp">sysListener.listenTCP</a></li>
        <li><a href="#socket">socket</a></li>
        <li><a href="#ä¸­åœºå°ç»“">ä¸­åœºå°ç»“</a></li>
        <li><a href="#syssocket">sysSocket</a></li>
        <li><a href="#setdefaultsockopts">setDefaultSockopts</a></li>
        <li><a href="#newfd">newFD</a></li>
        <li><a href="#fdlistenstream">fd.listenStream</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><em>goæºç è§£æä¹‹TCPè¿æ¥ç³»åˆ—åŸºäºgoæºç 1.16.5</em></p>
<h1 id="ç«¯å£æ˜¯å¦‚ä½•ç›‘å¬çš„">ç«¯å£æ˜¯å¦‚ä½•ç›‘å¬çš„</h1>
<p>é¦–å…ˆå¥‰ä¸Šnetæ–‡æ¡£ä¸­ç¬¬ä¸€ä¸ªæ˜ å…¥çœ¼å¸˜çš„example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">ln, err := net.Listen(&#34;tcp&#34;, &#34;:8080&#34;)
if err != nil {
        // handle error
}
for {
        conn, err := ln.Accept()
        if err != nil {
                // handle error
        }
        go handleConnection(conn)
}
</code></pre></td></tr></table>
</div>
</div><p><strong>ä¸‹é¢æˆ‘ä»¬é€šè¿‡é€è¡Œè·Ÿè¸ªæºç ï¼Œæ¥çœ‹å¼€å¯ç›‘å¬çš„è¿‡ç¨‹ï¼š</strong></p>
<h2 id="1-netlisten">1. net.Listen</h2>
<p>src\net\dial.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">funcÂ Listen(network,Â addressÂ string)Â (Listener,Â error)Â {
Â Â Â Â varÂ lcÂ ListenConfig
Â Â Â Â returnÂ lc.Listen(context.Background(),Â network,Â address)
}
</code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç›‘å¬æ–¹æ³•ï¼Œå…¶ä¸­networkå¯ä»¥æ˜¯tcpã€tcp4ã€tcp6ã€unixã€unixpacketï¼Œæˆ‘ä»¬é€šå¸¸ä¼ å…¥tcpå³ä»£è¡¨ç›‘å¬tcpè¿æ¥ï¼ŒåŒ…æ‹¬ipv4å’Œipv6ï¼Œå…¶ä»–ç±»å‹ä¸åœ¨æˆ‘ä»¬çš„ä»‹ç»èŒƒå›´ï¼ŒåŒ…æ‹¬udpæœ¬æ–‡ä¹Ÿä¸è®¨è®ºã€‚addressæ˜¯ç›‘å¬çš„åœ°å€ï¼Œip:portæ ¼å¼ï¼Œå¦‚æœä¸æŒ‡å®športï¼Œå°†ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£ã€‚</p>
<p>ListenConfigçš„structä½“å¦‚ä¸‹ï¼š
src\net\dial.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">typeÂ ListenConfigÂ structÂ {
Â Â Â Â ControlÂ func(network,Â addressÂ string,Â cÂ syscall.RawConn)Â error
    KeepAlive time.Duration
}
</code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­Controlæ˜¯ä¸€ä¸ªæ–¹æ³•å˜é‡ï¼Œæ ¹æ®æ³¨é‡Šï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨è¿æ¥åˆ›å»ºä¹‹åå¹¶å°†è¿æ¥ç»‘å®šåˆ°æ“ä½œç³»ç»Ÿä¹‹å‰è°ƒç”¨ï¼Œç›¸å½“äºæ˜¯æä¾›ç»™ç”¨æˆ·å±‚çš„ä¸€ä¸ªè¿æ¥åˆ›å»ºçš„å›è°ƒæ–¹æ³•ï¼Œè‡³äºå®ƒçš„ç”¨å¤„å’Œè°ƒç”¨æ—¶æœºï¼Œéšç€åç»­æ›´æ·±å±‚çš„ä»£ç åˆ†æå†åšè¿›ä¸€æ­¥ä»‹ç»ã€‚
KeepAliveï¼Œåº”è¯¥å’Œå†…æ ¸å‚æ•°/proc/sys/net/ipv4/tcp_keepalive_timeã€tcp_keepalive_intvlã€tcp_keepalive_probesæ˜¯ç›¸åŒçš„ä½œç”¨ï¼Œä½†æ˜¯æ ¹æ®æ³¨é‡Šè¯´æ˜ï¼Œ0æ˜¯å¼€å¯ï¼Œè´Ÿæ•°æ˜¯å…³é—­ï¼Œæ²¡æœ‰è¯´æ˜æ­£æ•°çš„ä½œç”¨ã€‚åç»­ç”¨åˆ°å†ç ”ç©¶ã€‚</p>
<h2 id="2listenconfigçš„listenæ–¹æ³•">2.ListenConfigçš„Listenæ–¹æ³•</h2>
<p>src\net\dial.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func (lc *ListenConfig) Listen(ctx context.Context, network, address string) (Listener, error) {
	addrs, err := DefaultResolver.resolveAddrList(ctx, &#34;listen&#34;, network, address, nil)
	...
        sl := &amp;sysListener{
		ListenConfig: *lc,
		network:      network,
		address:      address,
	}
	var l Listener
	la := addrs.first(isIPv4)
	switch la := la.(type) {
	case *TCPAddr:
		l, err = sl.listenTCP(ctx, la)
        ...
	}
	...
	return l, nil
}
</code></pre></td></tr></table>
</div>
</div><p><em>å…¶ä¸­&hellip;ä»£è¡¨çœç•¥çš„ä¸€äº›ç»†èŠ‚å¤„ç†æˆ–è€…æ˜¯æ— å…³åˆ†æ”¯ï¼Œåç»­ä¹Ÿéƒ½ä¼šä»¥è¿™ç§æ–¹å¼è´´ä»£ç ã€‚</em></p>
<p>ListenConfigçš„Listenæ–¹æ³•åŒæ ·æ˜¯ä¼ å…¥äº†networkå’Œaddressï¼Œctxæ˜¯ä¸Šå±‚ä¼ å…¥çš„context.Background()ã€‚è¿”å›å€¼æ˜¯Listenerç±»å‹å’Œerrorï¼Œå…¶ä¸­çš„Listenerå…¶å®æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå…·ä½“æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š
src\net\net.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">type Listener interface {
	Accept() (Conn, error) //ç­‰å¾…å¹¶è¿”å›å»ºç«‹æˆåŠŸçš„è¿æ¥
	Close() error //å…³é—­ç›‘å¬
	Addr() Addr //ç›‘å¬åœ°å€
}
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å†çœ‹ListenConfigçš„Listenæ–¹æ³•çš„é€»è¾‘ï¼Œç¬¬ä¸€è¡Œå¯¹ä¼ å…¥çš„åœ°å€è¿›è¡Œäº†è§£æï¼Œè½¬æ¢æˆäº†ä¸‹å±‚å¯ç”¨çš„åœ°å€æ ¼å¼ã€‚ç´§æ¥ç€ç”Ÿæˆäº†ä¸€ä¸ªsysListenerçš„å˜é‡ï¼ŒsysListenerçš„ä½œç”¨å¾ˆç®€å•ï¼Œå®ƒçš„å­˜åœ¨å°±æ˜¯ä¸ºäº†æ„é€ å„ç§ç±»å‹çš„å®ç°äº†Listeneræ¥å£çš„ç›‘å¬å™¨ï¼Œå› æ­¤å®ƒçš„æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯listenXXXï¼ŒXXXåˆ™ä»£è¡¨ç½‘ç»œåè®®ç±»å‹ï¼Œä¾‹å¦‚è¿™é‡Œçš„listenTCPï¼Œè¿˜æœ‰listenUDPç­‰ç­‰ã€‚</p>
<h2 id="syslistenerlistentcp">sysListener.listenTCP</h2>
<p>ç»§ç»­çœ‹ä»£ç ï¼Œä¸‹é¢çš„switch caseæˆ‘ä»¬ä¸ç®¡ï¼Œç›´æ¥çœ‹caseæ˜¯TCPAddrçš„æƒ…å†µï¼Œè°ƒç”¨äº†sysListenerçš„listenTCPæ–¹æ³•ï¼Œæ–¹æ³•ä¸­ä»£ç å¦‚ä¸‹ï¼š</p>
<p>src\net\tcpsock_posix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func (sl *sysListener) listenTCP(ctx context.Context, laddr *TCPAddr) (*TCPListener, error) {
	fd, err := internetSocket(ctx, sl.network, laddr, nil, syscall.SOCK_STREAM, 0, &#34;listen&#34;, sl.ListenConfig.Control)
	if err != nil {
		return nil, err
	}
	return &amp;TCPListener{fd: fd, lc: sl.ListenConfig}, nil
}
</code></pre></td></tr></table>
</div>
</div><p>å¯è§sysListeneræ„é€ äº†ä¸€ä¸ªTCPListenerå¹¶è¿”å›ï¼Œçœ‹ä¸€ä¸‹internetSocketï¼ŒinternetSocketçš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªsocketï¼ŒTCPListenerå°†ä½¿ç”¨è¿™ä¸ªsocketæ¥ç›‘å¬ç«¯å£æ¥æ”¶è¿æ¥ï¼Œä¸‹é¢çœ‹å…·ä½“ä»£ç ï¼š</p>
<p>src\net\ipsock_posix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func internetSocket(ctx context.Context, net string, laddr, raddr sockaddr, sotype, proto int, mode string, ctrlFn func(string, string, syscall.RawConn) error) (fd *netFD, err error) {
	if (runtime.GOOS == &#34;aix&#34; || runtime.GOOS == &#34;windows&#34; || runtime.GOOS == &#34;openbsd&#34;) &amp;&amp; mode == &#34;dial&#34; &amp;&amp; raddr.isWildcard() {
		raddr = raddr.toLocal(net)
	}
	family, ipv6only := favoriteAddrFamily(net, laddr, raddr, mode)
	return socket(ctx, net, family, sotype, proto, ipv6only, laddr, raddr, ctrlFn)
}
</code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ–¹æ³•çš„å‚æ•°å¯çœŸé•¿ï¼Œæˆ‘ä»¬å¯¹ç…§æ–¹æ³•è°ƒç”¨ä¸€ä¸ªä¸ªçœ‹ä¸€ä¸‹ï¼š</p>
<ol>
<li>å‚æ•°1ï¼Œctxä¸è¯´äº†</li>
<li>å‚æ•°2ï¼Œnetï¼Œæ˜¯æˆ‘ä»¬æœ€åˆä¼ å…¥çš„networkï¼Œå³ç½‘ç»œåè®®ç±»å‹ï¼Œtcpã€udpç­‰</li>
<li>å‚æ•°3ï¼Œladdræ˜¯local addressçš„ç¼©å†™ï¼Œå³æœ¬åœ°åœ°å€ã€‚æˆ‘ä»¬æ„å»ºListeneréœ€è¦ä¼ å…¥æœ¬åœ°åœ°å€</li>
<li>å‚æ•°4ï¼Œraddræ˜¯remoe addressçš„ç¼©å†™ï¼Œå³è¿œç«¯åœ°å€ã€‚æ„å»ºListenerä¸éœ€è¦è¿œç«¯åœ°å€ï¼Œå½“è¿æ¥åˆ°è¿œç«¯æ—¶éœ€è¦raddr</li>
<li>å‚æ•°5ï¼Œsotypeï¼Œä¼ å…¥äº†syscall.SOCK_STREAMå³ä»£è¡¨è¿›è¡Œtcpç›‘å¬ï¼Œä¸ä¹‹å¯¹åº”çš„æ˜¯SOCK_DGRAM</li>
<li>å‚æ•°6ï¼Œprotoï¼Œé»˜è®¤0ã€‚</li>
<li>å‚æ•°7ï¼Œmodeï¼Œä¼ å…¥äº†listenï¼Œä»£è¡¨è¦å»ºç«‹çš„socketæ˜¯ç›‘å¬socket</li>
<li>å‚æ•°8ï¼ŒctrlFnï¼Œè¿™é‡Œå°±æ˜¯ä¸Šé¢ListenConfigçš„Controllerå±æ€§</li>
</ol>
<p>æ–¹æ³•çš„ç¬¬ä¸€éƒ¨åˆ†è¿˜æ˜¯åœ°å€è½¬æ¢ï¼Œç¬¬äºŒéƒ¨åˆ†çš„favoriteAddrFamilyæ–¹æ³•åˆ™æ˜¯è¿”å›äº†æ”¯æŒçš„åè®®ç°‡ï¼ˆAF_INETæˆ–è€…AF_INET6ï¼Œä»£è¡¨äº†ipv4å’Œipv6ï¼‰ï¼Œç¬¬ä¸‰éƒ¨åˆ†åˆ™æ˜¯socketæ–¹æ³•çš„è°ƒç”¨ï¼Œå®ƒçš„å…¥å‚å’ŒinternetSocketçš„åŸºæœ¬ä¸€è‡´ï¼Œè¿”å›å€¼æ˜¯*netFDï¼Œè€ŒnetFDåˆ™æ˜¯å¯¹ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦ï¼ˆsocketä¹Ÿæœ‰ä¸€ä¸ªå”¯ä¸€çš„æ–‡ä»¶æè¿°ç¬¦fdä¸ä¹‹å¯¹åº”ï¼‰çš„åŒ…è£…ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹socketæ–¹æ³•ä¸­æ˜¯æ€ä¹ˆåˆ›å»ºnetFDçš„ï¼š</p>
<h2 id="socket">socket</h2>
<p>src\net\sock_posix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func socket(ctx context.Context, net string, family, sotype, proto int, ipv6only bool, laddr, raddr sockaddr, ctrlFn func(string, string, syscall.RawConn) error) (fd *netFD, err error) {
	s, err := sysSocket(family, sotype, proto)
	if err != nil {
		return nil, err
	}
	if err = setDefaultSockopts(s, family, sotype, ipv6only); err != nil {
		poll.CloseFunc(s)
		return nil, err
	}
	if fd, err = newFD(s, family, sotype, net); err != nil {
		poll.CloseFunc(s)
		return nil, err
	}

	if laddr != nil &amp;&amp; raddr == nil {
		switch sotype {
		case syscall.SOCK_STREAM, syscall.SOCK_SEQPACKET:
			if err := fd.listenStream(laddr, listenerBacklog(), ctrlFn); err != nil {
				fd.Close()
				return nil, err
			}
			return fd, nil
                ...
	}
	if err := fd.dial(ctx, laddr, raddr, ctrlFn); err != nil {
		fd.Close()
		return nil, err
	}
	return fd, nil
}
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä»ä¸Šåˆ°ä¸‹ä»‹ç»æ¯ä¸ªæ–¹æ³•è°ƒç”¨çš„ä½œç”¨ï¼š</p>
<ol>
<li>sysSocketï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ›å»ºç³»ç»Ÿsocket</li>
<li>setDefaultSockoptsï¼Œè®¾ç½®äº†socketçš„ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚æ˜¯å¦åªæ”¯æŒipv6</li>
<li>newFDï¼Œå¯¹è¿”å›çš„ç³»ç»Ÿfdè¿›è¡Œäº†åŒ…è£…ï¼Œç”Ÿæˆäº†æœ¬æ–¹æ³•è¦è¿”å›çš„netFD</li>
<li>if laddr != nil &amp;&amp; raddr == nilï¼Œå¦‚æœä¼ å…¥äº†æœ¬åœ°åœ°å€ï¼Œæ²¡æœ‰ä¼ å…¥è¿œç«¯åœ°å€ï¼Œåˆ™è®¤ä¸ºæ–°çš„socketæ˜¯ç”¨æ¥ç›‘å¬çš„ï¼Œè°ƒç”¨äº†netFDçš„listenStreamè¿›è¡Œç«¯å£ç»‘å®šï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå°†ctrlFnï¼ˆListenConfigçš„Controllerå±æ€§ï¼‰åˆä¸€æ¬¡ä¼ å…¥ï¼Œé‚£ä¹ˆListenConfigçš„Controlleræ–¹æ³•å±æ€§æ˜¯åœ¨socketåˆ›å»ºä¹‹åæ‰§è¡Œçš„ï¼Œå…·ä½“åœ¨ä»€ä¹ˆæ“ä½œä¹‹å‰ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥è·Ÿä»£ç ã€‚</li>
<li>fd.dialï¼Œæ˜¯ä¼ å…¥äº†è¿œç«¯åœ°å€çš„æƒ…å†µï¼Œåˆ™è®¤ä¸ºæ–°çš„socketæ˜¯ç”¨æ¥connectçš„ï¼Œdialè¿›è¡Œäº†è¿æ¥ã€‚</li>
</ol>
<p>ä¸€ä¸ªtcpçš„ç›‘å¬socketåˆ›å»ºå®Œæˆã€è¿›è¡Œäº†ç«¯å£ç»‘å®šï¼Œå¹¶å°†æ­¤socketçš„fdåŒ…è£…æˆäº†netFDè¿”å›ç»™è°ƒç”¨è€…ï¼Œæ²¿ç€è°ƒç”¨é“¾ä¸€ç›´å‘ä¸Šè¿”å›åˆ°sysListenerçš„listenTCPæ–¹æ³•ï¼Œä¸ºæ–¹ä¾¿å¤§å®¶æŸ¥çœ‹ï¼Œå°†ä¸Šé¢è´´è¿‡çš„ä»£ç å†æ¬¡è´´åˆ°è¿™é‡Œï¼š</p>
<p>src\net\tcpsock_posix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func (sl *sysListener) listenTCP(ctx context.Context, laddr *TCPAddr) (*TCPListener, error) {
	fd, err := internetSocket(ctx, sl.network, laddr, nil, syscall.SOCK_STREAM, 0, &#34;listen&#34;, sl.ListenConfig.Control)
	if err != nil {
		return nil, err
	}
	return &amp;TCPListener{fd: fd, lc: sl.ListenConfig}, nil
}
</code></pre></td></tr></table>
</div>
</div><h2 id="ä¸­åœºå°ç»“">ä¸­åœºå°ç»“</h2>
<p>åœ¨ç»§ç»­æ·±å…¥sysSocketã€setDefaultSockoptsã€newFDã€listenStreamå‡ ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬ç°åœ¨é€šè¿‡ä¸€å¼ å›¾æ¥å›é¡¾ä¸€ä¸‹å‰é¢çš„è°ƒç”¨è¿‡ç¨‹</p>
<p><img src="/1.png" alt="1"></p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ•´ä¸ªé€»è¾‘é™¤äº†æœ€ä¸‹å±‚çš„socketæ–¹æ³•ä¸­ç•¥æ˜¾å¤æ‚ï¼Œå…¶ä»–æ¯ä¸ªæ–¹æ³•ä½“éƒ½å¾ˆå°ï¼Œä½†æ˜¯è°ƒç”¨é“¾è·¯è¿˜æ˜¯æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æ¥ç®€å•æ€»ç»“ä¸‹æ¯ä¸€å±‚çš„ä»£ç è®¾è®¡ã€‚</p>
<ol>
<li>net.Listenæ˜¯æ•´ä¸ªé“¾è·¯çš„å…¥å£æ–¹æ³•ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„ListenConfigï¼Œå¹¶è°ƒç”¨äº†ListenConfigçš„Listenæ–¹æ³•</li>
<li>ListenConfigï¼Œå®ƒç›®å‰æ‹¥æœ‰ä¸¤ä¸ªå¯é€‰é…ç½®é¡¹ï¼šControlå’ŒKeepAliveã€‚å®ƒå°†è¢«ä½œä¸ºé…ç½®æ•°æ®ä¼ é€’ç»™ä¸‹æ¸¸ï¼Œè®¾è®¡æˆä¸€ä¸ªstructå¯ä»¥é¿å…é€šè¿‡ä¼ å‚çš„æ–¹å¼ä¼ é€’å¾ˆå¤šé…ç½®</li>
<li>ListenConfig.Listenæ–¹æ³•ï¼Œå°†ä¸Šå±‚ä¼ å…¥çš„å­—ç¬¦ä¸²ç±»å‹çš„addressè½¬æ¢æˆä¸‹å±‚ä½¿ç”¨çš„Addræ•°æ®ï¼Œå¹¶é€šè¿‡åˆ¤æ–­networkçš„ç±»å‹è°ƒç”¨sysListenerçš„ä¸åŒçš„listenæ–¹æ³•ï¼ˆlistenTCPã€listenUDPç­‰ï¼‰</li>
<li>sysListenerå°†ListenConfigã€addressã€networkä½œä¸ºè‡ªå·±çš„å±æ€§ï¼Œå¹¶å®ç°äº†å„ç§networkçš„listenæ–¹æ³•</li>
<li>sysListener.listenTCPæ–¹æ³•ï¼Œè°ƒç”¨internetSocketæ–¹æ³•ï¼Œå¹¶ä½¿ç”¨è¿”å›çš„netFDåˆ›å»ºTCPListener</li>
<li>internetSocketæ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªåˆ›å»ºç›‘å¬socketå’Œconnect socketï¼ˆdialæ–¹æ³•ä¸»åŠ¨å‘èµ·è¿æ¥ï¼‰çš„å…±ç”¨æ–¹æ³•</li>
<li>socketæ–¹æ³•ï¼Œæ˜¯unixsockå’Œipsockçš„å…±ç”¨æ–¹æ³•ï¼Œå®ƒé¦–å…ˆåˆ›å»ºäº†socketå¹¶ä¸ºsocketè®¾ç½®é»˜è®¤å±æ€§ï¼Œå†å°†è¿”å›çš„fdåŒ…è£…æˆnetFDï¼Œæœ€åä½¿ç”¨æ­¤socketç»‘å®šç«¯å£æˆ–è€…è¿›è¡Œè¿æ¥ã€‚</li>
<li>æœ€ç»ˆå°†TCPListenerè¿”å›ç»™net.Listençš„è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…å¯ä»¥è°ƒç”¨TCPListenerçš„Acceptæ–¹æ³•å¼€å§‹æ¥å—è¿æ¥è¯·æ±‚ï¼Œè¿™ä¸€éƒ¨åˆ†å°†åœ¨ä¸‹ä¸€ç¯‡ä¸­ä»‹ç»ã€‚</li>
</ol>
<p>ä¸‹é¢ç»§ç»­ä»‹ç»sysSocketã€setDefaultSockoptsã€newFDã€listenStreamå‡ ä¸ªæ–¹æ³•</p>
<h2 id="syssocket">sysSocket</h2>
<p>è€å¥—è·¯ï¼Œå…ˆç¥­å‡ºä»£ç ï¼š</p>
<p>src\net\sock_cloexec.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func sysSocket(family, sotype, proto int) (int, error) {
	s, err := socketFunc(family, sotype|syscall.SOCK_NONBLOCK|syscall.SOCK_CLOEXEC, proto)

	...
    
	return s, nil
}
</code></pre></td></tr></table>
</div>
</div><p>ä¸­é—´çœç•¥éƒ¨åˆ†æ˜¯socketFuncæŠ¥é”™åçš„å®¹é”™å¤„ç†ï¼Œè€ç‰ˆæœ¬å†…æ ¸ç”±äºä¸æ”¯æŒåˆ›å»ºsocketæ—¶è®¾ç½®SOCK_NONBLOCKæˆ–è€…SOCK_CLOEXECï¼Œå¯¼è‡´åˆ›å»ºå¤±è´¥ã€‚çœç•¥éƒ¨åˆ†è¿›è¡Œäº†å®¹é”™ï¼Œå…ˆåˆ›å»ºsocketï¼Œå†è¿›è¡Œsocketå±æ€§çš„è®¾ç½®ã€‚</p>
<p>åœ¨è·Ÿå…¥socketFuncä¹‹å‰å…ˆä»‹ç»ä¸€ä¸‹å®ƒçš„å‚æ•°ï¼š</p>
<ol>
<li>familyæ˜¯AF_INETæˆ–è€…AF_INET6ï¼Œå³ipv4æˆ–è€…ipv6</li>
<li>sotypeæ˜¯SOCK_STREAMæˆ–è€…SOCK_DGRAMï¼Œå³tcpæˆ–è€…udp</li>
<li>SOCK_NONBLOCKæ˜¯å°†socketè®¾ç½®ä¸ºéé˜»å¡</li>
<li>SOCK_CLOEXECæ˜¯å°†socketè®¾ç½®ä¸ºclose-on-exec</li>
<li>protoé»˜è®¤0</li>
</ol>
<p>socketFuncæ˜¯ä¸€ä¸ªå…¨å±€çš„æ–¹æ³•å˜é‡ï¼Œå®ƒçš„å€¼å¦‚ä¸‹ï¼š</p>
<p>src\net\hook_unix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">var (
	...

	// Placeholders for socket system calls.
	socketFunc        func(int, int, int) (int, error)  = syscall.Socket
	connectFunc       func(int, syscall.Sockaddr) error = syscall.Connect
	listenFunc        func(int, int) error              = syscall.Listen
	getsockoptIntFunc func(int, int, int) (int, error)  = syscall.GetsockoptInt
)
</code></pre></td></tr></table>
</div>
</div><p>å¯è§é™¤äº†socketFuncä¹‹å¤–ï¼Œè¿˜æœ‰connectFuncã€listenFuncã€getsockoptIntFuncï¼Œå®ƒä»¬éƒ½æ˜¯syscallåŒ…é‡Œçš„æ–¹æ³•ã€‚</p>
<p>ç»§ç»­è·Ÿå…¥syscall.Socket:</p>
<p>src\syscall\syscall_unix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func Socket(domain, typ, proto int) (fd int, err error) {
	if domain == AF_INET6 &amp;&amp; SocketDisableIPv6 {
		return -1, EAFNOSUPPORT
	}
	fd, err = socket(domain, typ, proto)
	return
}
</code></pre></td></tr></table>
</div>
</div><p>src\syscall\zsyscall_linux_amd64.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT

func socket(domain int, typ int, proto int) (fd int, err error) {
	r0, _, e1 := RawSyscall(SYS_SOCKET, uintptr(domain), uintptr(typ), uintptr(proto))
	fd = int(r0)
	if e1 != 0 {
		err = errnoErr(e1)
	}
	return
}
</code></pre></td></tr></table>
</div>
</div><p>src\syscall\zsysnum_linux_amd64.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">const {
    ...
    SYS_SOCKET                 = 41
    ...
}
</code></pre></td></tr></table>
</div>
</div><p>src\syscall\asm_linux_amd64.s</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2, err uintptr)
TEXT Â·RawSyscall(SB),NOSPLIT,$0-56
	MOVQ	a1+8(FP), DI
	MOVQ	a2+16(FP), SI
	MOVQ	a3+24(FP), DX
	MOVQ	trap+0(FP), AX	// syscall entry
	SYSCALL
        ...
</code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Š4æ®µä»£ç é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å®ç°äº†ä¸€ä¸ªsocketçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åçš„rawSyscallæ˜¯ä½¿ç”¨æ±‡ç¼–å®ç°çš„ä¸€æ®µç³»ç»Ÿè°ƒç”¨æ–¹æ³•ï¼Œåˆ›å»ºsocketçš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯SYS_SOCKETã€‚</p>
<h2 id="setdefaultsockopts">setDefaultSockopts</h2>
<p>è€è§„çŸ©ï¼Œä¸Šä»£ç ï¼š</p>
<p>src\net\sockopt_linux.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func setDefaultSockopts(s, family, sotype int, ipv6only bool) error {
	if family == syscall.AF_INET6 &amp;&amp; sotype != syscall.SOCK_RAW {
		syscall.SetsockoptInt(s, syscall.IPPROTO_IPV6, syscall.IPV6_V6ONLY, boolint(ipv6only))
	}
	if (sotype == syscall.SOCK_DGRAM || sotype == syscall.SOCK_RAW) &amp;&amp; family != syscall.AF_UNIX {
		// Allow broadcast.
		return os.NewSyscallError(&#34;setsockopt&#34;, syscall.SetsockoptInt(s, syscall.SOL_SOCKET, syscall.SO_BROADCAST, 1))
	}
	return nil
}
</code></pre></td></tr></table>
</div>
</div><p>å¯è§ä»£ç åœ¨ä¸€å®šæ¡ä»¶ä¸‹è®¾ç½®äº†æ˜¯å¦åªå…è®¸ipv6ã€‚å¦‚æœæ˜¯udpçš„è¯ï¼Œè¿˜å°†socketè®¾ç½®ä¸ºå…è®¸å¹¿æ’­ã€‚
syscall.SetsockoptIntæ–¹æ³•åŒsyscall.Socketæ–¹æ³•ï¼Œéƒ½æ˜¯syscallä¸­çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h2 id="newfd">newFD</h2>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç ï¼š</p>
<p>src\net\fd_unix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func newFD(sysfd, family, sotype int, net string) (*netFD, error) {
	ret := &amp;netFD{
		pfd: poll.FD{
			Sysfd:         sysfd,
			IsStream:      sotype == syscall.SOCK_STREAM,
			ZeroReadIsEOF: sotype != syscall.SOCK_DGRAM &amp;&amp; sotype != syscall.SOCK_RAW,
		},
		family: family,
		sotype: sotype,
		net:    net,
	}
	return ret, nil
}
</code></pre></td></tr></table>
</div>
</div><p>newFDæ–¹æ³•å°†åˆ›å»ºæˆåŠŸçš„ç³»ç»ŸfdåŒ…è£…æˆäº†netFDï¼Œä¸‹é¢æŒ‘é€‰å‡ ä¸ªnetFDçš„é‡è¦æ–¹æ³•æ¥äº†è§£å®ƒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func (fd *netFD) Read(p []byte) (n int, err error)
func (fd *netFD) Write(p []byte) (nn int, err error)
func (fd *netFD) SetDeadline(t time.Time)
func (fd *netFD) SetReadDeadline(t time.Time)
func (fd *netFD) SetWriteDeadline(t time.Time)
func (fd *netFD) connect(ctx context.Context, la, ra syscall.Sockaddr) (rsa syscall.Sockaddr, ret error)
func (fd *netFD) accept() (netfd *netFD, err error)
func (fd *netFD) dial(ctx context.Context, laddr, raddr sockaddr, ctrlFn func(string, string, syscall.RawConn) error) error
func (fd *netFD) listenStream(laddr sockaddr, backlog int, ctrlFn func(string, string, syscall.RawConn) error) error
func (fd *netFD) listenDatagram(laddr sockaddr, ctrlFn func(string, string, syscall.RawConn) error) error
</code></pre></td></tr></table>
</div>
</div><p>netFDé™¤äº†å…·æœ‰è¯»å†™socketçš„æ–¹æ³•ï¼Œè¿˜å®ç°äº†listenã€acceptåŠdialæ–¹æ³•ã€‚</p>
<h2 id="fdlistenstream">fd.listenStream</h2>
<p>socketåˆ›å»ºæˆåŠŸåï¼Œè¿›è€Œå°±æ˜¯è¿›è¡Œç«¯å£ç»‘å®šå’Œç›‘å¬ï¼Œçœ‹ä»£ç ï¼š</p>
<p>src\net\sock_posix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func (fd *netFD) listenStream(laddr sockaddr, backlog int, ctrlFn func(string, string, syscall.RawConn) error) error {
	
        ...
    
	if ctrlFn != nil {
		c, err := newRawConn(fd)
		if err != nil {
			return err
		}
		if err := ctrlFn(fd.ctrlNetwork(), laddr.String(), c); err != nil {
			return err
		}
	}
	if err = syscall.Bind(fd.pfd.Sysfd, lsa); err != nil {
		return os.NewSyscallError(&#34;bind&#34;, err)
	}
	if err = listenFunc(fd.pfd.Sysfd, backlog); err != nil {
		return os.NewSyscallError(&#34;listen&#34;, err)
	}
	
        ...
    
	return nil
}
</code></pre></td></tr></table>
</div>
</div><p><em>çœç•¥å»äº†ä¸€äº›åˆå§‹åŒ–å’Œåœ°å€è½¬æ¢çš„ä»£ç ã€‚</em></p>
<p>syscall.Bindåˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæ³¨æ„fd.pfd.Sysfdå°±æ˜¯æˆ‘ä»¬æ–°åˆ›å»ºçš„socketçš„fdï¼Œlsaåˆ™æ˜¯æˆ‘ä»¬æœ€åˆä¼ å…¥çš„ip:portç»è¿‡è½¬æ¢åçš„åœ°å€ï¼ŒBindå°†è¿™ä¸ªåœ°å€ç»‘å®šåˆ°æˆ‘ä»¬åˆ›å»ºçš„socketä¸Šã€‚
listenFuncæ˜¯ä¸€ä¸ªæ–¹æ³•å˜é‡ï¼Œå­˜å‚¨å„ç§æ“ä½œç³»ç»Ÿçš„Listenæ–¹æ³•ï¼š</p>
<p>src\net\hook_unix.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">listenFunc        func(int, int) error              = syscall.Listen
</code></pre></td></tr></table>
</div>
</div><p>ç»è¿‡Listenç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬çš„socketå°±è¢«æ¿€æ´»äº†ï¼Œå†…æ ¸å°†æ¥æ”¶è¿æ¥åˆ°æ­¤socketçš„è¿æ¥è¯·æ±‚ã€‚ä¸‹ä¸€æ­¥è°ƒç”¨acceptå°±å¯ä»¥å–åˆ°è¿æ¥è¯·æ±‚çš„socketäº†ã€‚</p>
<p>å‘¼å‘¼ğŸ˜“ï¼Œç»ˆäºæŠŠç«¯å£ç»‘å®šå’Œç›‘å¬çš„å¤§ä½“ä»£ç æµç¨‹æ‹å®Œäº†ã€‚çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼Œæœ¬æ–‡å¯¹åº”åˆ°äº†TCP Serverçš„ç›‘å¬socketåˆ›å»ºå’Œbindã€listenï¼Œä¸‹ä¸€ç« å°†ç»§ç»­ä»‹ç»acceptã€‚</p>
<p><img src="/2.png" alt="2"></p>
<p>æœ€åå°†å¼€å¤´ListenConfigçš„Controllerå±æ€§çš„è°ƒç”¨æ—¶æœºè¡¥ä¸Šï¼ŒnetFD.listenStreamæ–¹æ³•ä¸­çš„ctrlFnå°±æ˜¯è¿™ä¸ªå±æ€§ï¼Œå¯è§å®ƒæ˜¯åœ¨ç›‘å¬socketåˆ›å»ºåï¼Œbindè°ƒç”¨ä¹‹å‰è¢«å›è°ƒçš„ã€‚åº”è¯¥æ˜¯å¼€æ”¾ç»™åº”ç”¨å±‚ä¸ªæ€§åŒ–è®¾ç½®socketçš„å±æ€§çš„ã€‚</p>
<p>æœ€æœ€åå†æŠŠbacklogè¯´ä¸€ä¸‹ğŸ˜„ï¼Œåœ¨netFD.listenStreamæ–¹æ³•ä¸­çš„<code>listenFunc(fd.pfd.Sysfd, backlog)</code>è¿™ä¸€è¡Œä¸­çš„backlogå‚æ•°æ§åˆ¶ç€å¾…å¤„ç†è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œæ–°çš„è¿æ¥è¯·æ±‚å°†è¢«å¿½ç•¥ã€‚backlogçš„å€¼å–è‡ªç³»ç»Ÿå‚æ•°ï¼ˆlinuxç³»ç»Ÿï¼‰<code>/proc/sys/net/core/somaxconn</code>ï¼Œå¦‚æœè¯»å–å¤±è´¥ï¼Œé»˜è®¤è®¾ç½®ä¸º128ã€‚å¦‚æœå€¼è¶…è¿‡backlogå¯ä»¥å­˜å‚¨çš„æœ€å¤§å€¼ï¼ˆå†…æ ¸ç‰ˆæœ¬4.1ä»¥ä¸‹backlogä½¿ç”¨uint16å­˜å‚¨ï¼Œé«˜ç‰ˆæœ¬ä½¿ç”¨uint32å­˜å‚¨ï¼‰ï¼Œå°†è¢«è®¾ç½®ä¸ºå¯å­˜å‚¨çš„æœ€å¤§å€¼ã€‚</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">åˆ˜ç®</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-02-12
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/go/">Go</a>
          <a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">æºç è§£æ</a>
          <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">ç½‘ç»œç¼–ç¨‹</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/go-tcp2/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">goæºç è§£æä¹‹TCPè¿æ¥ï¼ˆäºŒï¼‰â€”â€”Accept</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="erberry/erberry.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:skyscar@126.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/erberry" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/liu-wei-54-20" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzk0MDI2Nzc3Mw==&amp;action=getalbum&amp;album_id=2008233094889144321&amp;scene=173&amp;subscene=0&amp;sessionid=1644638615&amp;enterid=1644638666&amp;from_msgid=2247484265&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" class="iconfont icon-wechat" title="wechat"></a>
  <a href="https://erberry.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>åˆ˜ç®</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-191525181-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
